name: Build Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - version: "23.05.5"
            sdk_url: "https://downloads.openwrt.org/releases/23.05.5/targets/x86/64/openwrt-sdk-23.05.5-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"

    steps:
    - name: Checkout mwan3nft
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3-setuptools rsync unzip zlib1g-dev file wget zstd

    - name: Download and extract SDK
      run: |
        echo "Downloading SDK from: ${{ matrix.sdk_url }}"
        wget --no-check-certificate -q "${{ matrix.sdk_url }}" -O sdk.archive || {
          echo "Primary URL failed, trying mirror..."
          wget --no-check-certificate -q "https://mirror-03.infra.openwrt.org/releases/${{ matrix.version }}/targets/x86/64/openwrt-sdk-${{ matrix.version }}-x86-64_gcc-*.tar.xz" -O sdk.archive || {
            echo "Mirror also failed, using OpenWrt official SDK"
            wget --no-check-certificate -q "https://downloads.openwrt.org/releases/23.05.5/targets/x86/64/openwrt-sdk-23.05.5-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz" -O sdk.archive
          }
        }
        
        # Extract based on file type
        file sdk.archive
        if file sdk.archive | grep -q "XZ"; then
          tar -xJf sdk.archive
        elif file sdk.archive | grep -q "Zstandard"; then
          zstd -d sdk.archive -o sdk.tar
          tar -xf sdk.tar
        else
          tar -xf sdk.archive
        fi
        
        # Find and rename SDK directory
        SDK_DIR=$(ls -d *-sdk-* 2>/dev/null | head -1)
        if [ -n "$SDK_DIR" ]; then
          mv "$SDK_DIR" sdk
        else
          echo "SDK directory not found!"
          ls -la
          exit 1
        fi

    - name: Copy mwan3nft package
      run: |
        mkdir -p sdk/package/mwan3nft
        cp -r Makefile files sdk/package/mwan3nft/
        cp -r luci-app-mwan3nft sdk/package/

    - name: Update and install feeds
      working-directory: sdk
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Build mwan3nft
      working-directory: sdk
      run: |
        make defconfig
        make package/mwan3nft/compile V=s -j$(nproc) || make package/mwan3nft/compile V=s -j1

    - name: Build luci-app-mwan3nft
      working-directory: sdk
      run: |
        make package/luci-app-mwan3nft/compile V=s -j$(nproc) || make package/luci-app-mwan3nft/compile V=s -j1

    - name: Check build results
      run: |
        echo "=== Build Results for ImmortalWrt ${{ matrix.version }} ==="
        find sdk/bin -name "*.ipk" -type f 2>/dev/null || true

        MWAN3NFT_IPK=$(find sdk/bin -name "mwan3nft_*.ipk" -type f 2>/dev/null | head -1)
        LUCI_IPK=$(find sdk/bin -name "luci-app-mwan3nft*.ipk" -type f 2>/dev/null | head -1)

        if [ -n "$MWAN3NFT_IPK" ]; then
          echo "✅ mwan3nft package built: $MWAN3NFT_IPK"
        else
          echo "❌ mwan3nft package build failed"
          exit 1
        fi

        if [ -n "$LUCI_IPK" ]; then
          echo "✅ luci-app-mwan3nft package built: $LUCI_IPK"
        else
          echo "❌ luci-app-mwan3nft package build failed"
          exit 1
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mwan3nft-immortalwrt-${{ matrix.version }}
        path: |
          sdk/bin/packages/**/mwan3nft*.ipk
          sdk/bin/packages/**/luci-app-mwan3nft*.ipk
        retention-days: 7
