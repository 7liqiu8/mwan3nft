name: Build Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - version: "23.05.3"
            sdk_url: "https://downloads.immortalwrt.org/releases/23.05.3/targets/x86/64/immortalwrt-sdk-23.05.3-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
          - version: "24.10.0"
            sdk_url: "https://downloads.immortalwrt.org/releases/24.10.0/targets/x86/64/immortalwrt-sdk-24.10.0-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst"

    steps:
    - name: Checkout mwan3nft
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3-setuptools rsync unzip zlib1g-dev file wget zstd

    - name: Download and extract SDK
      run: |
        wget -q "${{ matrix.sdk_url }}" -O sdk.tar
        if [[ "${{ matrix.sdk_url }}" == *.zst ]]; then
          zstd -d sdk.tar -o sdk.tar.extracted
          tar -xf sdk.tar.extracted
        else
          tar -xf sdk.tar
        fi
        mv immortalwrt-sdk-* sdk

    - name: Copy mwan3nft package
      run: |
        mkdir -p sdk/package/mwan3nft
        cp -r Makefile files sdk/package/mwan3nft/
        cp -r luci-app-mwan3nft sdk/package/

    - name: Update and install feeds
      working-directory: sdk
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Build mwan3nft
      working-directory: sdk
      run: |
        make defconfig
        make package/mwan3nft/compile V=s -j$(nproc) || make package/mwan3nft/compile V=s -j1

    - name: Build luci-app-mwan3nft
      working-directory: sdk
      run: |
        make package/luci-app-mwan3nft/compile V=s -j$(nproc) || make package/luci-app-mwan3nft/compile V=s -j1

    - name: Check build results
      run: |
        echo "=== Build Results for ImmortalWrt ${{ matrix.version }} ==="
        find sdk/bin -name "*.ipk" -type f 2>/dev/null || true

        MWAN3NFT_IPK=$(find sdk/bin -name "mwan3nft_*.ipk" -type f 2>/dev/null | head -1)
        LUCI_IPK=$(find sdk/bin -name "luci-app-mwan3nft*.ipk" -type f 2>/dev/null | head -1)

        if [ -n "$MWAN3NFT_IPK" ]; then
          echo "✅ mwan3nft package built: $MWAN3NFT_IPK"
        else
          echo "❌ mwan3nft package build failed"
          exit 1
        fi

        if [ -n "$LUCI_IPK" ]; then
          echo "✅ luci-app-mwan3nft package built: $LUCI_IPK"
        else
          echo "❌ luci-app-mwan3nft package build failed"
          exit 1
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mwan3nft-immortalwrt-${{ matrix.version }}
        path: |
          sdk/bin/packages/**/mwan3nft*.ipk
          sdk/bin/packages/**/luci-app-mwan3nft*.ipk
        retention-days: 7
