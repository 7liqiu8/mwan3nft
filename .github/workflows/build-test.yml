name: Build Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - branch: openwrt-23.05
            target: x86
            subtarget: 64
          - branch: openwrt-24.10
            target: x86
            subtarget: 64

    steps:
    - name: Checkout mwan3nft
      uses: actions/checkout@v4
      with:
        path: mwan3nft

    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo apt-get clean
        df -h

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3-setuptools rsync unzip zlib1g-dev file wget libelf-dev \
          python3-pyelftools

    - name: Clone ImmortalWrt source
      run: |
        git clone --depth=1 -b ${{ matrix.branch }} https://github.com/immortalwrt/immortalwrt openwrt

    - name: Copy mwan3nft package
      run: |
        mkdir -p openwrt/package/mwan3nft
        cp -r mwan3nft/Makefile mwan3nft/files openwrt/package/mwan3nft/
        cp -r mwan3nft/luci-app-mwan3nft openwrt/package/

    - name: Update and install feeds
      working-directory: openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Generate config
      working-directory: openwrt
      run: |
        cat > .config << EOF
        CONFIG_TARGET_${{ matrix.target }}=y
        CONFIG_TARGET_${{ matrix.target }}_${{ matrix.subtarget }}=y
        CONFIG_PACKAGE_mwan3nft=y
        CONFIG_PACKAGE_luci-app-mwan3nft=y
        EOF
        make defconfig

    - name: Download packages
      working-directory: openwrt
      run: |
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: Build mwan3nft packages
      working-directory: openwrt
      run: |
        make package/mwan3nft/compile V=s -j$(nproc) || make package/mwan3nft/compile V=s -j1
        make package/luci-app-mwan3nft/compile V=s -j$(nproc) || make package/luci-app-mwan3nft/compile V=s -j1

    - name: Check build results
      run: |
        echo "=== Build Results for ${{ matrix.branch }} ==="
        find openwrt/bin -name "*.ipk" -type f | head -20

        MWAN3NFT_IPK=$(find openwrt/bin -name "mwan3nft_*.ipk" -type f | head -1)
        LUCI_IPK=$(find openwrt/bin -name "luci-app-mwan3nft*.ipk" -type f | head -1)

        if [ -n "$MWAN3NFT_IPK" ]; then
          echo "✅ mwan3nft package built: $MWAN3NFT_IPK"
        else
          echo "❌ mwan3nft package build failed"
          exit 1
        fi

        if [ -n "$LUCI_IPK" ]; then
          echo "✅ luci-app-mwan3nft package built: $LUCI_IPK"
        else
          echo "❌ luci-app-mwan3nft package build failed"
          exit 1
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mwan3nft-immortalwrt-${{ matrix.branch }}
        path: |
          openwrt/bin/packages/*/base/mwan3nft*.ipk
          openwrt/bin/packages/*/luci/luci-app-mwan3nft*.ipk
        retention-days: 7
