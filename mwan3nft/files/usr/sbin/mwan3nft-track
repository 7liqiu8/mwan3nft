#!/bin/sh
# SPDX-License-Identifier: GPL-2.0-only
# mwan3nft-track - Interface health tracking daemon

MWAN3NFT_LIB_DIR="/usr/lib/mwan3nft"
MWAN3NFT_STATUS_DIR="/var/run/mwan3nft"
MWAN3NFT_PID_DIR="/var/run/mwan3nft/track"

. /lib/functions.sh
. /lib/functions/network.sh
. "${MWAN3NFT_LIB_DIR}/common.sh"

INTERFACE="$1"

[ -z "$INTERFACE" ] && {
	echo "Usage: mwan3nft-track <interface>"
	exit 1
}

config_load mwan3nft

# Get interface configuration
config_get ENABLED "$INTERFACE" enabled 0
config_get FAMILY "$INTERFACE" family "ipv4"
config_get TRACK_IPS "$INTERFACE" track_ip "223.5.5.5 119.29.29.29"
config_get TRACK_METHOD "$INTERFACE" track_method "ping"
config_get RELIABILITY "$INTERFACE" reliability 2
config_get COUNT "$INTERFACE" count 1
config_get SIZE "$INTERFACE" size 56
config_get MAX_TTL "$INTERFACE" max_ttl 60
config_get TIMEOUT "$INTERFACE" timeout 4
config_get INTERVAL "$INTERFACE" interval 10
config_get FAILURE_INTERVAL "$INTERFACE" failure_interval 5
config_get RECOVERY_INTERVAL "$INTERFACE" recovery_interval 5
config_get DOWN "$INTERFACE" down 5
config_get UP "$INTERFACE" up 5
config_get INITIAL_STATE "$INTERFACE" initial_state "online"

[ "$ENABLED" = "0" ] && {
	mwan3nft_log "info" "Interface $INTERFACE is disabled, exiting tracker"
	exit 0
}

# Initialize state
CURRENT_STATE="$INITIAL_STATE"
SCORE=0
LOST=0
TURN=0

# Write PID file
echo $$ > "${MWAN3NFT_PID_DIR}/${INTERFACE}.pid"

# Write initial status
echo "$CURRENT_STATE" > "${MWAN3NFT_STATUS_DIR}/${INTERFACE}.status"

# Cleanup on exit
cleanup() {
	rm -f "${MWAN3NFT_PID_DIR}/${INTERFACE}.pid"
	exit 0
}

trap cleanup INT TERM

# Get device and gateway for interface
get_interface_info() {
	network_get_device DEVICE "$INTERFACE"
	network_get_gateway GATEWAY "$INTERFACE"

	if [ "$FAMILY" = "ipv6" ]; then
		network_get_gateway6 GATEWAY "$INTERFACE"
	fi
}

# Ping check
do_ping_check() {
	local target="$1"
	local result

	if [ -z "$DEVICE" ]; then
		return 1
	fi

	if [ "$FAMILY" = "ipv6" ]; then
		result=$(ping6 -I "$DEVICE" -c "$COUNT" -W "$TIMEOUT" -s "$SIZE" -t "$MAX_TTL" "$target" 2>/dev/null | grep -c "bytes from")
	else
		result=$(ping -I "$DEVICE" -c "$COUNT" -W "$TIMEOUT" -s "$SIZE" -t "$MAX_TTL" "$target" 2>/dev/null | grep -c "bytes from")
	fi

	[ "$result" -ge 1 ] && return 0
	return 1
}

# HTTP check
do_http_check() {
	local target="$1"
	local result

	if [ -z "$DEVICE" ]; then
		return 1
	fi

	result=$(curl --interface "$DEVICE" -s -o /dev/null -w "%{http_code}" --connect-timeout "$TIMEOUT" "http://$target" 2>/dev/null)

	[ "$result" = "200" ] || [ "$result" = "301" ] || [ "$result" = "302" ] && return 0
	return 1
}

# Arping check (for gateway)
do_arping_check() {
	local target="$1"
	local result

	if [ -z "$DEVICE" ]; then
		return 1
	fi

	result=$(arping -I "$DEVICE" -c "$COUNT" -w "$TIMEOUT" "$target" 2>/dev/null | grep -c "reply from")

	[ "$result" -ge 1 ] && return 0
	return 1
}

# Perform health check
do_check() {
	local success=0
	local ip

	for ip in $TRACK_IPS; do
		case "$TRACK_METHOD" in
			ping)
				do_ping_check "$ip" && success=$((success + 1))
				;;
			httping)
				do_http_check "$ip" && success=$((success + 1))
				;;
			arping)
				do_arping_check "$ip" && success=$((success + 1))
				;;
			*)
				do_ping_check "$ip" && success=$((success + 1))
				;;
		esac
	done

	[ "$success" -ge "$RELIABILITY" ] && return 0
	return 1
}

# Update interface state
update_state() {
	local new_state="$1"

	if [ "$new_state" != "$CURRENT_STATE" ]; then
		CURRENT_STATE="$new_state"
		echo "$CURRENT_STATE" > "${MWAN3NFT_STATUS_DIR}/${INTERFACE}.status"

		mwan3nft_log "notice" "Interface $INTERFACE state changed to $CURRENT_STATE"

		# Notify main daemon
		if [ "$CURRENT_STATE" = "online" ]; then
			/usr/sbin/mwan3nft ifup "$INTERFACE" &
		else
			/usr/sbin/mwan3nft ifdown "$INTERFACE" &
		fi
	fi
}

# Main tracking loop
mwan3nft_log "info" "Starting tracker for interface $INTERFACE"

while true; do
	# Get current interface info
	get_interface_info

	# Check if interface has device
	if [ -z "$DEVICE" ]; then
		mwan3nft_log "debug" "Interface $INTERFACE has no device, waiting..."
		sleep "$INTERVAL"
		continue
	fi

	# Perform health check
	if do_check; then
		# Check passed
		LOST=0

		if [ "$CURRENT_STATE" = "offline" ]; then
			SCORE=$((SCORE + 1))
			if [ "$SCORE" -ge "$UP" ]; then
				SCORE=0
				update_state "online"
			fi
		else
			SCORE=0
		fi

		sleep "$INTERVAL"
	else
		# Check failed
		SCORE=0
		LOST=$((LOST + 1))

		if [ "$CURRENT_STATE" = "online" ]; then
			if [ "$LOST" -ge "$DOWN" ]; then
				LOST=0
				update_state "offline"
				sleep "$FAILURE_INTERVAL"
			else
				sleep "$FAILURE_INTERVAL"
			fi
		else
			sleep "$RECOVERY_INTERVAL"
		fi
	fi

	TURN=$((TURN + 1))
done
